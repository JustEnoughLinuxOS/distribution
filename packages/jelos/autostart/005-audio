#!/bin/sh
# SPDX-License-Identifier: Apache-2.0
# Copyright (C) 2021-present Fewtarius (https://github.com/fewtarius)

# Minimal OS variable loading for performance
. /etc/profile.d/02-distribution

tocon "Configuring Audio..."

STATE=$(systemctl isactive pipewire)
if [ "${STATE}" = "inactive" ]
then
  systemctl start pipewire
fi

### Configures device detection and auto switching.
###
### These should be loaded by pipewire-pulse.conf but they fail
### to load there.

pactl load-module module-udev-detect &>/dev/null
pactl load-module module-switch-on-connect &>/dev/null

### Set the default audio path, needed for some devices
if [ ! -z "${DEVICE_PLAYBACK_PATH_SPK}" ]
then
  amixer cset name='Playback Path' ${DEVICE_PLAYBACK_PATH_SPK}
fi

VOLUME=$(get_setting audio.volume)
if [[ -z ${VOLUME} ]]
then
  VOLUME="60"
elif [[ -n "${DEVICE_VOLUME}" ]]
then
  VOLUME="${DEVICE_VOLUME}"
fi

/usr/bin/volume ${VOLUME}

